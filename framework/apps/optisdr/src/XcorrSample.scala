import uct.rrsg.dsl.optisdr._
import scala.virtualization.lms.common.Record
import scala.reflect.SourceContext

object mXCorrSample extends OptiSDRApplicationRunner with mxcorrapp
trait mxcorrapp extends OptiSDRApplication
{ 
  	def main() = 
  	{
  		
			//val incx = DenseVector[Float](1,true)
			//
			val ftpoint = 2048
			val L = ftpoint*130000						
			//val ml = 65000 // Output Matrix length
			//val chunk = ftpoint*ml
			//val streamout = ComplexDenseVector(L)
			val outp = DenseMatrix[Float](20,4096*1300)
			//val refsig = makeComplexVector("1 + 0i,0.999289472640589 + 0.0376901826699345i,0.993611310520008 + 0.112856384873482i,0.982287250728689 + 0.187381314585725i,0.954864544746643 + 0.297041581577035i,0.915241172620918 + 0.402906435713663i,0.844327925502015 + 0.535826794978997i,0.754251380736104 + 0.656585755752956i,0.617859613090334 + 0.786288432136619i,0.459579860621488 + 0.888136448813544i,0.248689887164855 + 0.968583161128631i,0.0251300954433378 + 0.9996841892833i,-0.236498997023724 + 0.971631732914674i,-0.481753674101715 + 0.876306680043864i,-0.720309024887907 + 0.693653305812805i,-0.893841424151264 + 0.448383216090033i,-0.992114701314478 + 0.125333233564305i,-0.977268123568193 + -0.212007109922055i,-0.830595899195813 + -0.556875616488188i,-0.567268949126756 + -0.823532597628427i,-0.187381314585725 + -0.982287250728689i,0.224270760949381 + -0.974526872786577i,0.627691361290701 + -0.778462301567023i,0.90482705246602 + -0.425779291565072i,0.998736956606017 + 0.0502443181797697i,0.857526656193652 + 0.514439533781506i,0.481753674101715 + 0.876306680043864i,-0.0251300954433374 + 0.9996841892833i,-0.556875616488188 + 0.830595899195813i,-0.915241172620918 + 0.402906435713662i,-0.982287250728689 + -0.187381314585725i,-0.702649969798849 + -0.711535677209285i,-0.137790290684639 + -0.990461425696651i,0.481753674101714 + -0.876306680043864i,0.925077206834458 + -0.379779095521802i,0.958521789017376 + 0.285019262469975i,0.535826794978997 + 0.844327925502015i,-0.150225589120756 + 0.988651744737914i,-0.786288432136618 + 0.617859613090336i,-0.996133609143173 + -0.0878511965507407i,-0.637423989748691 + -0.770513242775788i,0.100361714851213 + -0.9949510169813i,0.801566984870875 + -0.597904983057522i,0.98228725072869 + 0.187381314585719i,0.492727341548297 + 0.870183754669523i,-0.344642923174511 + 0.938733857653876i,-0.951056516295152 + 0.309016994374953i,-0.830595899195816 + -0.556875616488183i,-0.037690182669942 + -0.999289472640589i,0.786288432136613 + -0.617859613090342i,0.951056516295157 + 0.309016994374938i,0.272951935517335 + 0.962027671586083i,-0.675332808121017 + 0.737513117358181i,-0.98228725072869 + -0.187381314585716i,-0.32094360980722 + -0.947098304994741i,0.666011867434242 + -0.745941145424191i,0.968583161128634 + 0.248689887164842i,0.224270760949395 + 0.974526872786574i,-0.786288432136611 + 0.617859613090345i,-0.893841424151269 + -0.448383216090021i,0.0627905195292992 + -0.998026728428272i,0.942990535892859 + -0.332819544523002i,0.647055961569454 + 0.76244251101144i,-0.481753674101707 + 0.876306680043868i,-0.984564334529207 + -0.175023058975267i,-0.150225589120765 + -0.988651744737913i,0.904827052466015 + -0.425779291565082i,0.66601186743426 + 0.745941145424174i,-0.556875616488181 + 0.830595899195817i,-0.942990535892866 + -0.332819544522982i,0.1253332335643 + -0.992114701314478i,0.996133609143172 + -0.0878511965507467i,0.260841506289902 + 0.965381638833273i,-0.904827052466017 + 0.425779291565079i,-0.546394346734272 + -0.83752804004214i,0.754251380736104 + -0.656585755752957i,0.728968627421411 + 0.684547105928689i,-0.607930297694607 + 0.793990398647834i,-0.830595899195813 + -0.556875616488188i,0.50362320163576 + -0.863923417192836i,0.876306680043863 + 0.481753674101717i,-0.459579860621492 + 0.888136448813542i,-0.882291226434951 + -0.470703932165338i,0.481753674101721 + -0.87630668004386i,0.850994481794685 + 0.525174629961306i,-0.567268949126772 + 0.823532597628417i,-0.77051324277578 + -0.637423989748701i,0.702649969798857 + -0.711535677209278i,0.617859613090325 + 0.786288432136626i,-0.857526656193659 + 0.514439533781495i,-0.368124552684661 + -0.929776485888258i,0.977268123568199 + -0.212007109922031i,0.012566039883332 + 0.999921044203816i,-0.982287250728686 + -0.187381314585741i,0.414375580993301 + -0.910105970684988i,0.786288432136607 + 0.617859613090349i,-0.809016994374962 + 0.587785252292453i,-0.344642923174488 + -0.938733857653885i,0.99928947264059 + -0.0376901826699075i,-0.272951935517348 + 0.962027671586079i,-0.809016994374933 + -0.587785252292493i,0.830595899195827 + -0.556875616488167i,0.199709980514376 + 0.979855052384253i,-0.982287250728682 + -0.187381314585761i,0.577572703422295 + -0.816339250717164i,0.503623201635735 + 0.863923417192851i,-0.998026728428274 + 0.0627905195292818i,0.391373666837233 + -0.920231847365858i,0.617859613090304 + 0.786288432136643i,-0.986685944207875 + 0.162637165194839i,0.368124552684716 + -0.929776485888236i,0.607930297694575 + 0.793990398647858i,-0.997158900260617 + 0.0753268055278938i,0.481753674101751 + -0.876306680043844i,0.437115766650891 + 0.899405251566391i,-0.986685944207862 + -0.162637165194921i,0.728968627421445 + -0.684547105928653i,0.100361714851156 + 0.994951016981306i,-0.830595899195779 + -0.556875616488239i,0.958521789017394 + -0.285019262469916i,-0.425779291565122 + 0.904827052465996i,-0.39137366683716 + -0.920231847365888i,0.934328942456592 + 0.356411878713304i,-0.904827052466048 + 0.425779291565011i,0.356411878713315 + -0.934328942456587i,0.391373666837137 + 0.920231847365898i,-0.904827052465993 + -0.425779291565129i,0.958521789017391 + -0.285019262469924i,-0.556875616488242 + 0.830595899195776i,-0.100361714851139 + -0.994951016981308i,0.684547105928632 + 0.728968627421465i,-0.986685944207855 + -0.162637165194962i,0.899405251566402 + -0.437115766650869i,-0.481753674101771 + 0.876306680043833i,-0.0753268055278587 + -0.997158900260619i,0.607930297694538 + 0.793990398647887i,-0.929776485888219 + -0.368124552684759i,0.986685944207882 + -0.162637165194796i,-0.786288432136669 + 0.617859613090271i,0.391373666837269 + -0.920231847365842i,0.06279051952923 + 0.998026728428277i,-0.503623201635679 + -0.863923417192883i,0.816339250717128 + 0.577572703422346i,-0.98228725072867 + -0.187381314585821i,0.979855052384265 + -0.199709980514319i,-0.830595899195858 + 0.55687561648812i,0.587785252292549 + -0.809016994374893i,-0.272951935517426 + 0.962027671586057i,-0.0376901826698286 + -0.999289472640593i,0.344642923174416 + 0.938733857653911i,-0.587785252292392 + -0.809016994375006i,0.786288432136562 + 0.617859613090407i,-0.910105970684953 + -0.414375580993378i,0.982287250728667 + 0.187381314585837i,-0.999921044203818 + 0.0125660398832364i,0.977268123568218 + -0.212007109921939i,-0.929776485888292 + 0.368124552684576i,0.857526656193705 + -0.514439533781419i,-0.786288432136689 + 0.617859613090245i,0.702649969798938 + -0.711535677209198i,-0.637423989748787 + 0.770513242775708i,0.567268949126862 + -0.823532597628355i,-0.525174629961399 + 0.850994481794628i,0.481753674101815 + -0.876306680043809i,-0.470703932165417 + 0.882291226434908i,0.459579860621558 + -0.888136448813508i,-0.481753674101786 + 0.876306680043825i,0.503623201635832 + -0.863923417192794i,-0.556875616488274 + 0.830595899195755i,0.607930297694704 + -0.79399039864776i,-0.684547105928767 + 0.728968627421338i,0.754251380736163 + -0.656585755752888i,-0.837528040042192 + 0.546394346734192i,0.90482705246606 + -0.425779291564987i,-0.965381638833304 + 0.260841506289786i,0.996133609143184 + -0.0878511965506076i,-0.992114701314463 + -0.125333233564422i,0.94299053589283 + 0.332819544523083i,-0.830595899195755 + -0.556875616488274i,0.666011867434173 + 0.745941145424253i,-0.425779291564958 + -0.904827052466074i,0.150225589120611 + 0.988651744737936i,0.175023058975405 + -0.984564334529182i,-0.481753674101815 + 0.876306680043809i,0.762442511011523 + -0.647055961569356i,-0.942990535892904 + 0.332819544522875i,0.998026728428263 + 0.0627905195294525i,-0.893841424151192 + -0.448383216090176i,0.617859613090221 + 0.786288432136708i,-0.224270760949258 + -0.974526872786606i,-0.24868988716498 + 0.968583161128599i,0.666011867434349 + -0.745941145424095i,-0.947098304994793 + 0.320943609807065i,0.982287250728656 + 0.187381314585895i,-0.737513117358068 + -0.67533280812114i,0.272951935517191 + 0.962027671586124i,0.309016994375082 + -0.95105651629511i,-0.786288432136708 + 0.617859613090221i,0.999289472640595 + -0.0376901826697694i,-0.830595899195709 + -0.556875616488343i,0.309016994374786 + 0.951056516295206i,0.344642923174661 + -0.938733857653821i,-0.870183754669602 + 0.492727341548156i,0.982287250728659 + 0.187381314585879i,-0.597904983057375 + -0.801566984870983i,-0.100361714851414 + 0.99495101698128i,0.770513242775906 + -0.637423989748548i,-0.996133609143158 + -0.0878511965509093i,0.617859613090201 + 0.786288432136723i,0.150225589120927 + -0.988651744737888i,-0.844327925502118 + 0.535826794978834i,0.958521789017315 + 0.285019262470181i,-0.379779095521618 + -0.925077206834533i,-0.481753674101874 + 0.876306680043776i,0.990461425696677 + -0.137790290684457i,-0.702649969798717 + -0.711535677209416i,-0.187381314585928 + 0.98228725072865i,0.91524117262101 + -0.402906435713454i,-0.830595899195695 + -0.556875616488364i,-0.0251300954435329 + 0.999684189283295i,0.876306680043959 + -0.481753674101542i,-0.857526656193549 + -0.514439533781678i,-0.0502443181799911 + 0.998736956606006i,0.904827052466123 + -0.425779291564853i,-0.778462301566881 + -0.627691361290877i,-0.224270760949586 + 0.97452687278653i,0.982287250728729 + -0.187381314585516i,-0.567268949126579 + -0.82353259762855i,-0.556875616488385 + 0.830595899195681i,0.977268123568139 + 0.212007109922307i,-0.125333233564064 + -0.992114701314508i,-0.893841424151365 + 0.448383216089831i,0.693653305812641 + 0.720309024888065i,0.481753674101918 + -0.876306680043752i,-0.971631732914628 + -0.236498997023915i,0.0251300954431772 + 0.999684189283304i,0.968583161128681 + -0.24868988716466i,-0.459579860621273 + -0.888136448813656i,-0.78628843213677 + 0.617859613090142i,0.754251380735942 + 0.656585755753143i,0.535826794979175 + -0.844327925501902i,-0.915241172620846 + -0.402906435713824i,-0.297041581577242 + 0.954864544746579i,0.98228725072864 + 0.187381314585978i,0.11285638487374 + -0.993611310519979i,-0.999289472640579 + -0.0376901826701974i,-2.27872327127412E-13 + 1i,0.999289472640597 + -0.0376901826697419i,-0.0376901826697013 + -0.999289472640598i,-0.9992894726406 + 0.0376901826696607i,-2.76875554818326E-13 + 1i,0.999289472640579 + 0.037690182670214i,0.112856384873725 + -0.993611310519981i,-0.982287250728649 + -0.18738131458593i,-0.297041581577274 + 0.954864544746569i,0.9152411726208 + 0.402906435713929i,0.535826794979245 + -0.844327925501858i,-0.754251380735909 + -0.65658575575318i,-0.786288432136781 + 0.617859613090129i,0.459579860621286 + 0.888136448813649i,0.968583161128698 + -0.248689887164596i,-0.0251300954430292 + -0.999684189283308i,-0.9716317329146 + -0.236498997024027i,-0.481753674101991 + 0.876306680043712i,0.693653305812604 + 0.720309024888101i,0.893841424151373 + -0.448383216089814i,-0.125333233564021 + -0.992114701314514i,-0.977268123568124 + -0.212007109922373i,-0.556875616488461 + 0.830595899195629i,0.567268949126483 + 0.823532597628616i,0.982287250728744 + -0.187381314585433i,0.224270760949637 + -0.974526872786518i,-0.778462301566833 + -0.627691361290937i,-0.904827052466166 + 0.425779291564761i,-0.0502443181801164 + 0.998736956606i,0.857526656193472 + 0.514439533781807i,0.876306680044016 + -0.481753674101439i,0.0251300954436181 + -0.999684189283293i,-0.830595899195633 + -0.556875616488455i,-0.915241172621064 + 0.402906435713331i,-0.187381314586084 + 0.98228725072862i,0.702649969798587 + 0.711535677209545i,0.990461425696697 + -0.137790290684307i,0.481753674101978 + -0.876306680043719i,-0.379779095521486 + -0.925077206834587i,-0.958521789017267 + -0.285019262470342i,-0.844327925502221 + 0.535826794978672i,-0.150225589121141 + 0.988651744737856i,0.617859613090057 + 0.786288432136837i,0.996133609143144 + 0.0878511965510606i,0.770513242776019 + -0.637423989748412i,0.100361714851614 + -0.99495101698126i,-0.597904983057195 + -0.801566984871118i,-0.982287250728612 + -0.187381314586125i,-0.870183754669709 + 0.492727341547967i,-0.344642923174835 + 0.938733857653758i,0.309016994374587 + 0.951056516295271i,0.830595899195578 + 0.556875616488537i,0.999289472640605 + -0.0376901826695108i,0.786288432136883 + -0.617859613089998i,")
			val refsig = makeComplexVector("1 + 0i,0.993611310520008 + 0.112856384873482i,0.942990535892865 + 0.332819544522987i,0.844327925502015 + 0.535826794978997i,0.617859613090334 + 0.786288432136619i,0.32094360980721 + 0.947098304994744i,-0.125333233564304 + 0.992114701314478i,-0.546394346734269 + 0.837528040042142i,-0.910105970684996 + 0.414375580993284i,-0.990461425696651 + -0.137790290684638i,-0.684547105928689 + -0.728968627421411i,-0.0753268055279335 + -0.997158900260614i,0.656585755752956 + -0.754251380736104i,0.998026728428272 + -0.0627905195293133i,0.666011867434251 + 0.745941145424183i,-0.175023058975277 + 0.984564334529205i,-0.929776485888252 + 0.368124552684676i,-0.801566984870875 + -0.597904983057521i,0.19970998051441 + -0.979855052384246i,0.971631732914675 + -0.236498997023721i,0.535826794978993 + 0.844327925502017i,-0.627691361290704 + 0.77846230156702i,-0.893841424151261 + -0.448383216090038i,0.248689887164861 + -0.968583161128629i,0.988651744737913 + 0.150225589120765i,-0.0502443181797781 + 0.998736956606017i,-0.998026728428271 + -0.0627905195293228i,0.0753268055279431 + -0.997158900260613i,0.979855052384245 + 0.199709980514418i,-0.320943609807221 + 0.94709830499474i,-0.844327925502008 + -0.535826794979008i,0.720309024887917 + -0.693653305812795i,0.402906435713652 + 0.915241172620922i,-0.998026728428272 + 0.0627905195293002i,0.391373666837216 + -0.920231847365865i,0.647055961569432 + 0.762442511011458i,-0.99211470131448 + 0.125333233564287i,0.437115766650949 + -0.899405251566363i,0.414375580993266 + 0.910105970685004i,-0.965381638833268 + -0.260841506289917i,0.876306680043874 + -0.481753674101696i,-0.297041581577057 + 0.954864544746636i,-0.344642923174494 + -0.938733857653883i,0.844327925502001 + 0.535826794979019i,-0.999684189283299 + -0.0251300954433656i,0.87018375466954 + -0.492727341548266i,-0.587785252292493 + 0.809016994374933i,0.199709980514432 + -0.979855052384242i,0.112856384873454 + 0.993611310520012i,-0.414375580993258 + -0.910105970685008i,0.587785252292448 + 0.809016994374966i,-0.737513117358152 + -0.675332808121048i,0.793990398647815 + 0.607930297694633i,-0.844327925501996 + -0.535826794979027i,0.830595899195791 + 0.55687561648822i,-0.816339250717161 + -0.5775727034223i,0.728968627421383 + 0.684547105928719i,-0.627691361290666 + -0.778462301567051i,0.414375580993243 + 0.910105970685015i,-0.175023058975229 + -0.984564334529214i,-0.187381314585774 + 0.982287250728679i,0.52517462996134 + -0.850994481794665i,-0.85752665619368 + 0.51443953378146i,0.998026728428275 + -0.0627905195292574i,-0.863923417192806 + -0.503623201635811i,0.437115766650878 + 0.899405251566398i,0.248689887164902 + -0.968583161128619i,-0.816339250717213 + 0.577572703422226i,0.979855052384236 + 0.199709980514459i,-0.525174629961249 + -0.850994481794721i,-0.368124552684732 + 0.92977648588823i,0.96538163883329 + -0.260841506289839i,-0.711535677209241 + -0.702649969798894i,-0.248689887164918 + 0.968583161128615i,0.986685944207879 + -0.162637165194817i,-0.54639434673421 + -0.83752804004218i,-0.637423989748746 + 0.770513242775743i,0.925077206834429 + 0.379779095521871i,0.199709980514484 + -0.979855052384231i,-0.999921044203815 + -0.0125660398834334i,0.06279051952923 + 0.998026728428277i,0.990461425696663 + -0.137790290684553i,-0.100361714851126 + -0.994951016981309i,-0.998026728428277 + 0.0627905195292217i,-0.0878511965508375 + 0.996133609143164i,0.971631732914651 + 0.23649899702382i,0.481753674101803 + -0.876306680043815i,-0.720309024887835 + -0.69365330581288i,-0.91010597068504 + 0.414375580993187i,0.0502443181796602 + 0.998736956606023i,0.904827052465972 + 0.425779291565174i,0.801566984870946 + -0.597904983057426i,-0.0376901826698159 + -0.999289472640594i,-0.84432792550195 + -0.535826794979099i,-0.958521789017403 + 0.285019262469884i,-0.414375580993375 + 0.910105970684954i,0.309016994374849 + 0.951056516295185i,0.870183754669473 + 0.492727341548384i,0.993611310520021 + -0.112856384873373i,0.73751311735825 + -0.675332808120941i,")
			//
			val h_signal = load("/home/swinberg/OptiSDR/201x_NetRad/ZA_Trials_2011_06/radarData/2011-06-04/e11_06_04_1740_34_P1_1_130000_S0_1_2047_node3.bin",L)
			//
			//val rl = real(refsig)
			//println(rl.length)
			//val im = imag(refsig)
			var j = 0
			val subchunk = 1300*2048;
			parwhile(j<19)
			{
				//stream(2048)
				//
				val htout = hilbert(h_signal(j*subchunk::j*subchunk+subchunk),ftpoint)
				//outp(j) = hilbert(h_signal(j*subchunk::j*subchunk+subchunk),ftpoint)//xcorr(htout,refsig,ftpoint)  //xcorr(htout,refsig,2048) // TODO: Fix Zero Padding and the xcorr cuda function
				//sync(2048*100)
				val ftout = fft(htout,ftpoint)
				outp(j) = real(ifft(ftout,ftpoint))
				j = j + 1
			}
			println(j)
			//val n3refsig = loadc("n3refsig.mat",4096) // Copied from NetRADARD Matlab Scripts - 300 Samples @ 50MHz
			//val inm1 = ParallelStreamIn(h_signal(0::6500*2048),ftpoint) //
			//val inm2 = ParallelStreamIn(h_signal(chunk::L),ftpoint) //
			//ref.pprint
			//val outm2 = fftmat_raw_data[Float](outm)
			//for(i<- 0 until outm2.length) println(outm2(i))
			//val cval1 = ComplexDenseVector(2048)
			/*val rl = real(refsig)
			val refpadded = xcorrpad(rl,2*2048,2*1300*2048)
			//refpadded(300::600).pprint
			refpadded(0::4096).pprint
			println("Output Len1:"+refpadded.length)
			//
			val sig = h_signal(0::1300*2048)
			val sigpadded = xcorrpad(sig,2048,2*2048,2)
			//
			sigpadded(0::4096).pprint
			//sigpadded(4096::2*4096).pprint
			println("Output Len2:"+sigpadded.length)*/
			/*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
			//%%% Parallel For Loop - parfor(start,stride,end)%%%%%%%%
			//%%% Make sure that no Sequential Ops are called here %%%
			//%%% No Mix of Par Ops and Seq. Ops otherwise run seq. %%
			//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*/
			//println("Begining Batched FFT Ops:");
			//val tc1 = tic
			//val ftout =  fft(inm1,2048,true)//hilbert(inm1) // Do Hilbert of Matrix, row-wise
			//println("Done Batched FFT Ops in: "+toc(tc1))
			//
			//println("Begining ParWhile Tests: ")
			/*println("Begining Batched FFT and ParWhile Processing:"+outp(0).length);
			val tc2 = tic
			var j = 0
			val subchunk = 1300*2048;
			parwhile(j<5)
			{
				//stream(2048)
				//val htout = hilbert(h_signal)
				//streamout = xcorr(htout,n3refsig)
				//streamout = fft(h_signal)
				//val inm1 = ParallelStreamIn(h_signal(j*subchunk::j*subchunk+subchunk),ftpoint) //
				//val tmp =  h_signal(j*subchunk::j*subchunk+subchunk)
				val htout = hilbert(h_signal(j*subchunk::j*subchunk+subchunk),2048)
				val tout = xcorr(htout,refsig,2048) 
				outp(j) = tout //xcorr(htout,refsig,2048) // TODO: Fix Zero Padding and the xcorr cuda function
				//sync(2048*100)
				j = j + 1
			}
			println("Done with ParWhile Test.."+toc(tc2))*/
			//x(0).pprint
			//m(0::2).pprint
			//tst.ddisp
			//
  	}
}